<template>
  <div class="performance-container">
    <h1>âš¡ SSR æ€§èƒ½ç›‘æ§é¢æ¿</h1>

    <!-- æ€§èƒ½æŒ‡æ ‡å¡ç‰‡ -->
    <section class="metrics-grid">
      <div class="metric-card">
        <div class="metric-icon">ğŸš€</div>
        <div class="metric-label">TTFB</div>
        <div class="metric-value">{{ metrics.ttfb }}</div>
        <div class="metric-desc">é¦–å­—èŠ‚æ—¶é—´</div>
      </div>

      <div class="metric-card">
        <div class="metric-icon">ğŸ¨</div>
        <div class="metric-label">FCP</div>
        <div class="metric-value">{{ metrics.fcp }}</div>
        <div class="metric-desc">é¦–æ¬¡å†…å®¹ç»˜åˆ¶</div>
      </div>

      <div class="metric-card">
        <div class="metric-icon">ğŸ“Š</div>
        <div class="metric-label">LCP</div>
        <div class="metric-value">{{ metrics.lcp }}</div>
        <div class="metric-desc">æœ€å¤§å†…å®¹ç»˜åˆ¶</div>
      </div>

      <div class="metric-card">
        <div class="metric-icon">âš¡</div>
        <div class="metric-label">TTI</div>
        <div class="metric-value">{{ metrics.tti }}</div>
        <div class="metric-desc">å¯äº¤äº’æ—¶é—´</div>
      </div>
    </section>

    <!-- æ¸²æŸ“æ¨¡å¼å¯¹æ¯” -->
    <section class="demo-section">
      <h2>ğŸ”„ SSR vs CSR å¯¹æ¯”</h2>
      <div class="info-card">
        <table class="comparison-table">
          <thead>
            <tr>
              <th>æŒ‡æ ‡</th>
              <th>SSRï¼ˆæœ¬é¡µé¢ï¼‰</th>
              <th>CSRï¼ˆä¼ ç»Ÿ SPAï¼‰</th>
              <th>ä¼˜åŠ¿</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>TTFB</td>
              <td :class="getPerformanceClass(metrics.ttfb)">{{ metrics.ttfb }}</td>
              <td class="csr-value">~200ms</td>
              <td>{{ compareMetric('ttfb', metrics.ttfb, 200) }}</td>
            </tr>
            <tr>
              <td>FCP</td>
              <td :class="getPerformanceClass(metrics.fcp)">{{ metrics.fcp }}</td>
              <td class="csr-value">~1500ms</td>
              <td>{{ compareMetric('fcp', metrics.fcp, 1500) }}</td>
            </tr>
            <tr>
              <td>LCP</td>
              <td :class="getPerformanceClass(metrics.lcp)">{{ metrics.lcp }}</td>
              <td class="csr-value">~2500ms</td>
              <td>{{ compareMetric('lcp', metrics.lcp, 2500) }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- æ€§èƒ½è¯¦æƒ… -->
    <section class="demo-section">
      <h2>ğŸ“ˆ è¯¦ç»†æ€§èƒ½æ•°æ®</h2>
      <div class="info-card">
        <div class="detail-grid">
          <div class="detail-item">
            <strong>é¡µé¢åŠ è½½æ—¶é—´ï¼š</strong>
            <span>{{ metrics.loadTime }}</span>
          </div>
          <div class="detail-item">
            <strong>DOM è§£ææ—¶é—´ï¼š</strong>
            <span>{{ metrics.domParse }}</span>
          </div>
          <div class="detail-item">
            <strong>èµ„æºåŠ è½½æ—¶é—´ï¼š</strong>
            <span>{{ metrics.resourceLoad }}</span>
          </div>
          <div class="detail-item">
            <strong>æ°´åˆæ—¶é—´ï¼š</strong>
            <span>{{ metrics.hydrationTime }}</span>
          </div>
        </div>
      </div>
    </section>

    <!-- æ€§èƒ½å»ºè®® -->
    <section class="demo-section">
      <h2>ğŸ’¡ SSR æ€§èƒ½ä¼˜åŠ¿</h2>
      <div class="info-card">
        <ul class="benefits-list">
          <li>
            <span class="benefit-icon">âœ…</span>
            <div>
              <strong>æ›´å¿«çš„é¦–å±æ¸²æŸ“</strong>
              <p>æœåŠ¡å™¨ç›´æ¥è¿”å›å®Œæ•´ HTMLï¼Œç”¨æˆ·ç«‹å³çœ‹åˆ°å†…å®¹</p>
            </div>
          </li>
          <li>
            <span class="benefit-icon">âœ…</span>
            <div>
              <strong>æ›´å¥½çš„ SEO</strong>
              <p>æœç´¢å¼•æ“å¯ä»¥ç›´æ¥æŠ“å–å®Œæ•´é¡µé¢å†…å®¹</p>
            </div>
          </li>
          <li>
            <span class="benefit-icon">âœ…</span>
            <div>
              <strong>é™ä½å®¢æˆ·ç«¯è´Ÿæ‹…</strong>
              <p>å‡å°‘å®¢æˆ·ç«¯ JavaScript æ‰§è¡Œæ—¶é—´</p>
            </div>
          </li>
          <li>
            <span class="benefit-icon">âœ…</span>
            <div>
              <strong>æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ</strong>
              <p>ç‰¹åˆ«æ˜¯åœ¨ä½é…ç½®è®¾å¤‡å’Œæ…¢é€Ÿç½‘ç»œç¯å¢ƒä¸‹</p>
            </div>
          </li>
        </ul>
      </div>
    </section>

    <!-- æ€§èƒ½è¯„åˆ† -->
    <section class="demo-section">
      <h2>ğŸ¯ æ€§èƒ½è¯„åˆ†</h2>
      <div class="info-card">
        <div class="score-container">
          <div class="score-circle" :class="getScoreClass(performanceScore)">
            <div class="score-value">{{ performanceScore }}</div>
            <div class="score-label">åˆ†</div>
          </div>
          <div class="score-description">
            <p><strong>{{ getScoreText(performanceScore) }}</strong></p>
            <p>{{ getScoreDescription(performanceScore) }}</p>
          </div>
        </div>
      </div>
    </section>

    <NuxtLink to="/" class="back-link">â† è¿”å›é¦–é¡µ</NuxtLink>
  </div>
</template>

<script setup>
import { ref, computed, onMounted } from 'vue';
import { useHead } from '#app';

// è®¾ç½®é¡µé¢å…ƒæ•°æ®
useHead({
  title: 'æ€§èƒ½ç›‘æ§ - Nuxt 4 SSR Demo',
  meta: [
    { name: 'description', content: 'å±•ç¤º Nuxt 4 SSR çš„æ€§èƒ½æŒ‡æ ‡å’Œä¼˜åŠ¿' }
  ]
});

// æ€§èƒ½æŒ‡æ ‡
const metrics = ref({
  ttfb: 'è®¡ç®—ä¸­...',
  fcp: 'è®¡ç®—ä¸­...',
  lcp: 'è®¡ç®—ä¸­...',
  tti: 'è®¡ç®—ä¸­...',
  loadTime: 'è®¡ç®—ä¸­...',
  domParse: 'è®¡ç®—ä¸­...',
  resourceLoad: 'è®¡ç®—ä¸­...',
  hydrationTime: 'è®¡ç®—ä¸­...'
});

// æ€§èƒ½è¯„åˆ†
const performanceScore = ref(0);

// æ ¼å¼åŒ–æ—¶é—´
const formatTime = (ms) => {
  if (ms === null || ms === undefined || isNaN(ms)) return 'N/A';
  return `${Math.round(ms)}ms`;
};

// è·å–æ€§èƒ½ç­‰çº§æ ·å¼
const getPerformanceClass = (value) => {
  if (value === 'è®¡ç®—ä¸­...' || value === 'N/A') return '';
  const ms = parseInt(value);
  if (ms < 500) return 'perf-good';
  if (ms < 1000) return 'perf-ok';
  return 'perf-poor';
};

// å¯¹æ¯”æŒ‡æ ‡
const compareMetric = (type, ssrValue, csrValue) => {
  if (ssrValue === 'è®¡ç®—ä¸­...' || ssrValue === 'N/A') return '-';
  const ssr = parseInt(ssrValue);
  const improvement = Math.round(((csrValue - ssr) / csrValue) * 100);
  return improvement > 0 ? `å¿« ${improvement}%` : 'ç›¸å½“';
};

// è·å–è¯„åˆ†ç­‰çº§
const getScoreClass = (score) => {
  if (score >= 90) return 'score-excellent';
  if (score >= 70) return 'score-good';
  if (score >= 50) return 'score-ok';
  return 'score-poor';
};

// è·å–è¯„åˆ†æ–‡æœ¬
const getScoreText = (score) => {
  if (score >= 90) return 'ä¼˜ç§€';
  if (score >= 70) return 'è‰¯å¥½';
  if (score >= 50) return 'ä¸€èˆ¬';
  return 'éœ€è¦ä¼˜åŒ–';
};

// è·å–è¯„åˆ†æè¿°
const getScoreDescription = (score) => {
  if (score >= 90) return 'SSR æ€§èƒ½è¡¨ç°å‡ºè‰²ï¼Œç”¨æˆ·ä½“éªŒæä½³';
  if (score >= 70) return 'SSR æ€§èƒ½è‰¯å¥½ï¼Œå¤§éƒ¨åˆ†æŒ‡æ ‡è¾¾æ ‡';
  if (score >= 50) return 'SSR æ€§èƒ½ä¸€èˆ¬ï¼Œä»æœ‰ä¼˜åŒ–ç©ºé—´';
  return 'SSR æ€§èƒ½éœ€è¦ä¼˜åŒ–ï¼Œå»ºè®®æ£€æŸ¥æœåŠ¡å™¨é…ç½®';
};

// è®¡ç®—æ€§èƒ½è¯„åˆ†
const calculateScore = () => {
  const ttfb = parseInt(metrics.value.ttfb) || 0;
  const fcp = parseInt(metrics.value.fcp) || 0;
  const lcp = parseInt(metrics.value.lcp) || 0;
  
  let score = 100;
  
  // TTFB è¯„åˆ†ï¼ˆæƒé‡ 30%ï¼‰
  if (ttfb > 600) score -= 30;
  else if (ttfb > 300) score -= 15;
  else if (ttfb > 100) score -= 5;
  
  // FCP è¯„åˆ†ï¼ˆæƒé‡ 35%ï¼‰
  if (fcp > 3000) score -= 35;
  else if (fcp > 1800) score -= 20;
  else if (fcp > 1000) score -= 10;
  
  // LCP è¯„åˆ†ï¼ˆæƒé‡ 35%ï¼‰
  if (lcp > 4000) score -= 35;
  else if (lcp > 2500) score -= 20;
  else if (lcp > 1500) score -= 10;
  
  performanceScore.value = Math.max(0, Math.round(score));
};

// å®¢æˆ·ç«¯æŒ‚è½½åè·å–æ€§èƒ½æ•°æ®
onMounted(() => {
  // ä½¿ç”¨ Performance API è·å–æ€§èƒ½æ•°æ®
  if (window.performance) {
    const perfData = window.performance.timing;
    const navigation = window.performance.getEntriesByType('navigation')[0];
    
    // è®¡ç®—å„é¡¹æŒ‡æ ‡
    metrics.value.ttfb = formatTime(perfData.responseStart - perfData.requestStart);
    metrics.value.loadTime = formatTime(perfData.loadEventEnd - perfData.navigationStart);
    metrics.value.domParse = formatTime(perfData.domContentLoadedEventEnd - perfData.domLoading);
    metrics.value.resourceLoad = formatTime(perfData.loadEventEnd - perfData.domContentLoadedEventEnd);
    
    // ä½¿ç”¨ PerformanceObserver è·å– FCP å’Œ LCP
    if ('PerformanceObserver' in window) {
      try {
        // FCP
        const fcpObserver = new PerformanceObserver((list) => {
          for (const entry of list.getEntries()) {
            if (entry.name === 'first-contentful-paint') {
              metrics.value.fcp = formatTime(entry.startTime);
            }
          }
        });
        fcpObserver.observe({ entryTypes: ['paint'] });
        
        // LCP
        const lcpObserver = new PerformanceObserver((list) => {
          const entries = list.getEntries();
          const lastEntry = entries[entries.length - 1];
          metrics.value.lcp = formatTime(lastEntry.startTime);
        });
        lcpObserver.observe({ entryTypes: ['largest-contentful-paint'] });
        
        // TTIï¼ˆç®€åŒ–ä¼°ç®—ï¼‰
        setTimeout(() => {
          metrics.value.tti = formatTime(performance.now());
          metrics.value.hydrationTime = formatTime(performance.now() - (perfData.domContentLoadedEventEnd - perfData.navigationStart));
          
          // è®¡ç®—è¯„åˆ†
          calculateScore();
        }, 100);
      } catch (e) {
        console.error('Performance Observer error:', e);
      }
    }
    
    // å¦‚æœ PerformanceObserver ä¸å¯ç”¨ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ
    setTimeout(() => {
      if (metrics.value.fcp === 'è®¡ç®—ä¸­...') {
        metrics.value.fcp = formatTime(perfData.domContentLoadedEventEnd - perfData.navigationStart);
      }
      if (metrics.value.lcp === 'è®¡ç®—ä¸­...') {
        metrics.value.lcp = formatTime(perfData.loadEventEnd - perfData.navigationStart);
      }
      if (metrics.value.tti === 'è®¡ç®—ä¸­...') {
        metrics.value.tti = formatTime(performance.now());
      }
      if (metrics.value.hydrationTime === 'è®¡ç®—ä¸­...') {
        metrics.value.hydrationTime = formatTime(performance.now() - (perfData.domContentLoadedEventEnd - perfData.navigationStart));
      }
      
      // è®¡ç®—è¯„åˆ†
      calculateScore();
    }, 1000);
  }
});
</script>

<style scoped>
.performance-container {
  max-width: 1100px;
  margin: 0 auto;
  padding: 20px;
}

h1 {
  color: #333;
  text-align: center;
  margin-bottom: 30px;
}

.metrics-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}

.metric-card {
  background: white;
  padding: 25px;
  border-radius: 10px;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
  text-align: center;
  transition: all 0.3s ease;
}

.metric-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
}

.metric-icon {
  font-size: 2.5rem;
  margin-bottom: 10px;
}

.metric-label {
  font-size: 0.9rem;
  color: #6b7280;
  margin-bottom: 8px;
  font-weight: 600;
}

.metric-value {
  font-size: 1.8rem;
  font-weight: bold;
  color: #667eea;
  margin-bottom: 5px;
}

.metric-desc {
  font-size: 0.85rem;
  color: #9ca3af;
}

.demo-section {
  margin-bottom: 30px;
}

.demo-section h2 {
  color: #667eea;
  margin-bottom: 15px;
  font-size: 1.5rem;
}

.info-card {
  background: white;
  padding: 25px;
  border-radius: 8px;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

.comparison-table {
  width: 100%;
  border-collapse: collapse;
}

.comparison-table th,
.comparison-table td {
  padding: 12px;
  text-align: left;
  border-bottom: 1px solid #e5e7eb;
}

.comparison-table th {
  background: #f8f9fa;
  font-weight: bold;
  color: #374151;
}

.comparison-table tr:hover {
  background: #f9fafb;
}

.perf-good {
  color: #22c55e;
  font-weight: bold;
}

.perf-ok {
  color: #f59e0b;
  font-weight: bold;
}

.perf-poor {
  color: #ef4444;
  font-weight: bold;
}

.csr-value {
  color: #9ca3af;
}

.detail-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 15px;
}

.detail-item {
  padding: 15px;
  background: #f8f9fa;
  border-radius: 6px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.detail-item strong {
  color: #374151;
}

.detail-item span {
  color: #667eea;
  font-weight: bold;
}

.benefits-list {
  list-style: none;
  padding: 0;
  margin: 0;
}

.benefits-list li {
  display: flex;
  gap: 15px;
  padding: 15px 0;
  border-bottom: 1px solid #e5e7eb;
}

.benefits-list li:last-child {
  border-bottom: none;
}

.benefit-icon {
  font-size: 1.5rem;
  flex-shrink: 0;
}

.benefits-list strong {
  color: #374151;
  display: block;
  margin-bottom: 5px;
}

.benefits-list p {
  color: #6b7280;
  margin: 0;
  font-size: 0.95rem;
}

.score-container {
  display: flex;
  gap: 30px;
  align-items: center;
  flex-wrap: wrap;
}

.score-circle {
  width: 150px;
  height: 150px;
  border-radius: 50%;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  border: 8px solid;
  flex-shrink: 0;
}

.score-excellent {
  border-color: #22c55e;
  background: #f0fdf4;
}

.score-good {
  border-color: #3b82f6;
  background: #eff6ff;
}

.score-ok {
  border-color: #f59e0b;
  background: #fffbeb;
}

.score-poor {
  border-color: #ef4444;
  background: #fef2f2;
}

.score-value {
  font-size: 3rem;
  font-weight: bold;
  color: inherit;
}

.score-label {
  font-size: 1rem;
  color: #6b7280;
}

.score-description {
  flex: 1;
}

.score-description p {
  margin: 8px 0;
  line-height: 1.6;
}

.score-description strong {
  font-size: 1.3rem;
  color: #374151;
}

.back-link {
  display: inline-block;
  margin-top: 30px;
  color: #667eea;
  text-decoration: none;
  font-weight: bold;
  font-size: 1.1rem;
}

.back-link:hover {
  text-decoration: underline;
}
</style>
